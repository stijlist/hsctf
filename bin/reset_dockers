#!/usr/bin/env ruby
require 'sequel'
$LOAD_PATH.unshift("#{File.dirname(__FILE__)}/../lib")
require 'hsctf'
DB = Sequel.connect(ENV["RDS_CONNECTION_STRING"])
DATA_DIR = "#{File.dirname(__FILE__)}/../assets/game_data/"

challenge_name = ARGV[0]
if challenge_name != ""
  challenges = [[challenge_name, challenge_name + '.yaml']]
else
  challenge_info = YAML.load_file(File.join(DATA_DIR, "challenges.yaml"))
  challenges = challenge_info["challenges"]
end
manager = Manager.new
challenges.each do |name, path|
  challenge = YAML.load_file(File.join(DATA_DIR, path))
  dockers = DB[:dockers]

  dockers.where(challenge_name: name).each do |docker|
    instance_id, port = manager.instance_for(challenge)
    dockers.where(player_id: docker[:player_id], challenge_name: name).update(instance_id: instance_id, port: port)
  end
end

